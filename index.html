<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spicks & Specks - Interactive Quiz</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- QR Code Library -->
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;900&display=swap');
        body { font-family: 'Poppins', sans-serif; margin: 0; padding: 0; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .animate-pulse { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        .image-crop-top {
            object-fit: cover;
            object-position: center 60%;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        const { Play, Users, Trophy, Clock, ChevronRight, Check, Volume2, Send, Copy, CheckCircle, QrCode } = lucide;

        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDwhaglPhs7KcKEEuKyjkPZDeYqW3lMBDA",
            authDomain: "spicks-specks-quiz.firebaseapp.com",
            databaseURL: "https://spicks-specks-quiz-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "spicks-specks-quiz",
            storageBucket: "spicks-specks-quiz.firebasestorage.app",
            messagingSenderId: "187006302593",
            appId: "1:187006302593:web:030e06cf345974a5011080"
        };

        // Initialize Firebase (only once)
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const database = firebase.database();

        const QUIZ_DATA = {
            rounds: [
                {
                    name: "Round 1: One-Hit Wonders",
                    color: "#FF6B6B",
                    questions: [
                        {
                            question: "ðŸŽµ Host: Play song preview | Name this 1998 one-hit wonder band",
                            options: ["New Radicals", "Semisonic", "Tal Bachman", "Eagle-Eye Cherry"],
                            correct: 0,
                            trivia: "The band broke up shortly after, despite the song's global success.",
                            points: 1
                        },
                        {
                            question: "ðŸŽµ Host: Play song preview | Name this 1997 American singer-songwriter",
                            options: ["Meredith Brooks", "Alanis Morissette", "Paula Cole", "Shawn Colvin"],
                            correct: 0,
                            trivia: "Brooks was often confused with Alanis because of the song's style and timing.",
                            points: 1
                        },
                        {
                            question: "ðŸŽµ Host: Play song preview | Name this 1996 one-hit wonder band",
                            options: ["Crash Test Dummies", "OMC", "Primitive Radio Gods", "EMF"],
                            correct: 1,
                            trivia: "OMC stood for 'Otara Millionaires Club', named after a suburb in Auckland, New Zealand.",
                            points: 1
                        },
                        {
                            question: "ðŸŽµ Host: Play song preview | Name this 1999 Canadian one-hit wonder band",
                            options: ["Our Lady Peace", "Barenaked Ladies", "Len", "The Tragically Hip"],
                            correct: 2,
                            trivia: "Bonus round! 3 points!",
                            points: 3
                        }
                    ]
                },
                {
                    name: "Round 2: Substitute - Corporate Edition",
                    color: "#4ECDC4",
                    questions: [
                        {
                            question: "What song do these corporate lyrics parody?",
                            lyrics: "Raise a new ticket, describe your issue clearly,\nPlease attach screenshots, and your OS version yearly,\nWhat browser are you using, what's your device model number?\nEscalation pending, SLA is looming under,\nI'm stuck in an endless circle of support team thunder,\nPriority high or low, they ask me to define,\nIs it blocking production or just wasting your time?\nCan you reproduce the error, walk me through each step?\nI've been on hold for hours, my patience has left,\nThey say 'have you tried restarting' like it's something new,\nI'm just trying to do my job, is that too much to ask of you?",
                            options: ["Smells Like Teen Spirit - Nirvana", "Bitter Sweet Symphony - The Verve", "Losing My Religion - R.E.M.", "Wonderwall - Oasis"],
                            correct: 0,
                            points: 1
                        },
                        {
                            question: "What song do these corporate lyrics parody?",
                            lyrics: "Each quarter I meet with my manager face to face,\nThey ask: 'Were goals met?' in this performance review space,\n'What's next quarter look like? What's your five-year plan?'\nI speak of OKRs, metrics, and timelines if I can,\nKey performance indicators, results I need to show,\nAreas of improvement, the feedback starts to flow,\nI nod and take notes, pretending that I care,\nAbout development goals and competencies to share,\nThey mention growth opportunities, stretch assignments too,\nSelf-assessment forms and ratings to review,\nI smile and agree, say I'll work on communication skills,\nWhile inside I'm wondering if I can pay my bills.",
                            options: ["Creep - Radiohead", "Black Hole Sun - Soundgarden", "Come As You Are - Nirvana", "Zombie - The Cranberries"],
                            correct: 0,
                            points: 1
                        },
                        {
                            question: "What song do these corporate lyrics parody?",
                            lyrics: "We're all in the call waiting to begin once more,\nSomeone's late, their camera's off, we've seen this before,\nThe agenda's vague, slides yet to load from the cloud,\n'Can everyone hear me?' someone asks the crowd,\n'You're on mute' we type in chat, the same old song,\nSmall talk about the weather while we wait for someone strong,\nTo take the lead and guide us through this Friday waste of time,\nAction items no one writes down, decisions that don't climb,\nBarbara from finance talks for twenty minutes straight,\nAbout her cat and weekend plans, we're running very late,\n'Let's take this offline' someone says to end the pain,\n'Great sync team, same time next week' we'll meet again.",
                            options: ["Everybody Hurts - R.E.M.", "No Rain - Blind Melon", "Semi-Charmed Life - Third Eye Blind", "Mr. Jones - Counting Crows"],
                            correct: 0,
                            points: 1
                        },
                        {
                            question: "What song do these corporate lyrics parody?",
                            lyrics: "Inbox has a thousand unread messages today,\nThreads upon threads of CCs and reply-alls in the way,\nI sort by 'urgent,' 'FYI,' 'please respond by end of day',\nSlack is pinging, Teams is ringing, no time for delay,\nSomeone tagged me in a comment on a doc I've never seen,\nA calendar invite with no context, what does this meeting mean?\nFive more emails while I read this, notifications never cease,\nMarked important with red flags, but none bring me peace,\nOut of office replies stack up, showing who's away,\nWhile I'm drowning in this digital mess of work display,\nUnsubscribe links tempt me but I'm scared I'll miss the news,\nAnother newsletter, another update, more things to peruse.",
                            options: ["Under Pressure - Queen & David Bowie", "Ice Ice Baby - Vanilla Ice", "U Can't Touch This - MC Hammer", "Jump Around - House of Pain"],
                            correct: 0,
                            points: 1
                        }
                    ]
                },
                {
                    name: "Round 3: Name That Artist",
                    color: "#95E1D3",
                    questions: [
                        {
                            question: "Which artist's real name is: Reginald Kenneth Dwight?",
                            options: ["Billy Joel", "Elton John", "Paul McCartney", "Phil Collins"],
                            correct: 1,
                            trivia: "He took 'Elton' from saxophonist Elton Dean and 'John' from singer Long John Baldry.",
                            points: 1
                        },
                        {
                            question: "Which artist's real name is: Elizabeth Woolridge Grant?",
                            options: ["Lorde", "Lana Del Rey", "Florence Welch", "Sky Ferreira"],
                            correct: 1,
                            trivia: "She chose 'Lana Del Rey' for its glamorous, cinematic quality.",
                            points: 1
                        },
                        {
                            question: "Which artist's real name is: Robyn Fenty?",
                            options: ["BeyoncÃ©", "Alicia Keys", "Rihanna", "JhenÃ© Aiko"],
                            correct: 2,
                            trivia: "Robyn is her first name, which she now uses as her stage name.",
                            points: 1
                        },
                        {
                            question: "Which artist's real name is: Alecia Beth Moore?",
                            options: ["Alicia Keys", "P!nk", "Avril Lavigne", "Hayley Williams"],
                            correct: 1,
                            trivia: "Her nickname came from the character Mr. Pink in Reservoir Dogs.",
                            points: 1
                        },
                        {
                            question: "Which artist's real name is: Eilleen Regina Edwards?",
                            options: ["Faith Hill", "LeAnn Rimes", "Shania Twain", "Martina McBride"],
                            correct: 2,
                            trivia: "She took the name 'Shania' meaning 'on my way' in Ojibwe.",
                            points: 1
                        },
                        {
                            question: "Which artist's real name is: Adam Richard Wiles?",
                            options: ["David Guetta", "Calvin Harris", "Zedd", "Adam Levine"],
                            correct: 1,
                            trivia: "He chose a stage name to sound more racially ambiguous for the dance music scene.",
                            points: 1
                        },
                        {
                            question: "Which artist's real name is: Belcalis Marlenis AlmÃ¡nzar?",
                            options: ["Nicki Minaj", "Cardi B", "Megan Thee Stallion", "Saweetie"],
                            correct: 1,
                            trivia: "Cardi B comes from Bacardi, a nickname based on the rum brand.",
                            points: 1
                        }
                    ]
                },
                {
                    name: "Round 4: Name That... (Music Edition)",
                    color: "#F38181",
                    questions: [
                        {
                            question: "Name this music festival",
                            imageUrl: "https://imgproxy.ra.co/_/quality:66/aHR0cHM6Ly9zdGF0aWMucmEuY28vaW1hZ2VzL25ld3MvMjAyNS9yLmpwZw==",
                            options: ["Glastonbury", "Roskilde Festival", "Primavera Sound", "Coachella"],
                            correct: 1,
                            trivia: "One of Europe's largest music festivals, held annually in Denmark since 1971.",
                            points: 1
                        },
                        {
                            question: "Name this iconic album",
                            imageUrl: "https://i.postimg.cc/7hJGRmR2/image-1.png",
                            options: ["Lonerism - Tame Impala", "Currents - Tame Impala", "Innerspeaker - Tame Impala", "The Slow Rush - Tame Impala"],
                            correct: 1,
                            trivia: "Kevin Parker's third studio album marked a shift towards more electronic and pop-influenced sound.",
                            points: 1
                        },
                        {
                            question: "Name this instrument",
                            imageUrl: "https://images.musicstore.de/images/1280/moog-etherwave-theremin_1_SYN0008187-000.jpg",
                            options: ["Ondes Martenot", "Telharmonium", "Theremin", "Mellotron"],
                            correct: 2,
                            trivia: "Invented in 1920, one of the earliest electronic instruments, played without touching.",
                            points: 1
                        },
                        {
                            question: "Name this album",
                            imageUrl: "https://i0.wp.com/alt77.com/wp-content/uploads/2024/11/Joy-Divison-22Unknown-Pleasures22-Reviewed-and-Revisited.jpg?resize=1140%2C694&ssl=1",
                            options: ["Closer - Joy Division", "Unknown Pleasures - Joy Division", "The Queen is Dead - The Smiths", "Loveless - My Bloody Valentine"],
                            correct: 1,
                            trivia: "The cover art is a plot of pulsar data from the 1970s.",
                            points: 1
                        },
                        {
                            question: "Name this artist",
                            imageUrl: "https://www.rollingstone.com/wp-content/uploads/2025/10/dangelo-flashback.jpg?w=1581&h=1054&crop=1",
                            options: ["Maxwell", "D'Angelo", "Musiq Soulchild", "Eric BenÃ©t"],
                            correct: 1,
                            trivia: "A pioneer of the neo-soul movement in the 1990s.",
                            points: 1
                        },
                        {
                            question: "Name this iconic music venue",
                            imageUrl: "https://www.architecture.com.au/wp-content/uploads/00_7572-heritage_SOHConcertHallRenewal_ARMArchitecture_DanielBoud-1.jpg",
                            options: ["Carnegie Hall", "Sydney Opera House", "Royal Albert Hall", "Vienna State Opera"],
                            correct: 1,
                            trivia: "Designed by Danish architect JÃ¸rn Utzon and opened in 1973.",
                            points: 1
                        }
                    ]
                }
            ]
        };

        // Main App Router
        const App = () => {
            const urlParams = new URLSearchParams(window.location.search);
            const mode = urlParams.get('mode');
            const sessionId = urlParams.get('session') || 'default';
            const playerId = urlParams.get('player');
            const teamId = urlParams.get('team');

            if (mode === 'join') {
                return <JoinPage sessionId={sessionId} />;
            } else if (mode === 'player' && playerId && teamId) {
                return <PlayerInterface sessionId={sessionId} playerId={playerId} teamId={teamId} />;
            } else if (mode === 'host' || !mode) {
                return <HostInterface sessionId={sessionId} />;
            }
            return <div className="p-8 text-center">Invalid URL parameters</div>;
        };

        // JOIN PAGE - Players scan QR code to get here
        const JoinPage = ({ sessionId }) => {
            const [gameState, setGameState] = useState(null);
            const [playerAssignments, setPlayerAssignments] = useState({});
            const [selectedTeam, setSelectedTeam] = useState(null);
            const [playerName, setPlayerName] = useState('');
            const [isJoining, setIsJoining] = useState(false);

            useEffect(() => {
                const gameRef = database.ref(`sessions/${sessionId}/game`);
                gameRef.on('value', (snapshot) => {
                    setGameState(snapshot.val());
                });

                const assignmentsRef = database.ref(`sessions/${sessionId}/playerAssignments`);
                assignmentsRef.on('value', (snapshot) => {
                    setPlayerAssignments(snapshot.val() || {});
                });

                return () => {
                    gameRef.off();
                    assignmentsRef.off();
                };
            }, [sessionId]);

            const joinTeam = async (teamId) => {
                if (!playerName.trim()) {
                    alert('Please enter your name');
                    return;
                }

                setIsJoining(true);

                // Find next available player slot
                const teamPrefix = teamId;
                let playerNumber = 1;
                
                // Find the next available player number for this team
                while (playerAssignments[`${teamPrefix}_player${playerNumber}`]) {
                    playerNumber++;
                }
                
                const assignedSlot = `player${playerNumber}`;
                const slotKey = `${teamPrefix}_${assignedSlot}`;
                
                // Reserve this slot
                await database.ref(`sessions/${sessionId}/playerAssignments/${slotKey}`).set({
                    name: playerName.trim(),
                    timestamp: Date.now()
                });
                
                // Redirect to player interface
                const playerUrl = `${window.location.origin}${window.location.pathname}?mode=player&session=${sessionId}&team=${teamId}&player=${assignedSlot}`;
                window.location.href = playerUrl;
            };

            if (!gameState) {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-purple-600 to-pink-600 flex items-center justify-center p-4">
                        <div className="bg-white rounded-3xl shadow-2xl p-8 text-center">
                            <div className="animate-pulse">
                                <h2 className="text-2xl font-bold mb-4">Loading quiz...</h2>
                            </div>
                        </div>
                    </div>
                );
            }

            const getTeamPlayerCount = (teamId) => {
                const teamPrefix = teamId;
                let count = 0;
                
                Object.keys(playerAssignments).forEach(key => {
                    if (key.startsWith(teamPrefix)) {
                        count++;
                    }
                });
                
                return count;
            };

            const team1Count = getTeamPlayerCount('team1');
            const team2Count = getTeamPlayerCount('team2');
            const team3Count = getTeamPlayerCount('team3');

            return (
                <div className="min-h-screen bg-gradient-to-br from-purple-600 via-pink-500 to-orange-400 flex items-center justify-center p-4">
                    <div className="bg-white rounded-3xl shadow-2xl p-8 max-w-md w-full">
                        <h1 className="text-4xl font-bold text-center text-transparent bg-clip-text bg-gradient-to-r from-purple-600 to-pink-600 mb-2">
                            ðŸŽµ Spicks & Specks ðŸŽµ
                        </h1>
                        <p className="text-center text-gray-600 mb-8">Join the quiz!</p>

                        <div className="mb-6">
                            <label className="block text-sm font-semibold mb-2">Your Name</label>
                            <input
                                type="text"
                                value={playerName}
                                onChange={(e) => setPlayerName(e.target.value)}
                                placeholder="Enter your name"
                                className="w-full px-4 py-3 border-2 rounded-xl focus:outline-none focus:border-purple-500"
                                disabled={isJoining}
                            />
                        </div>

                        <div className="space-y-4">
                            <button
                                onClick={() => joinTeam('team1')}
                                disabled={isJoining || !playerName.trim()}
                                className="w-full bg-gradient-to-r from-purple-500 to-purple-700 text-white py-4 rounded-xl font-bold text-lg hover:shadow-lg transition disabled:opacity-50 disabled:cursor-not-allowed"
                            >
                                <div className="flex justify-between items-center px-4">
                                    <span>Join {gameState.teamNames.team1}</span>
                                    <span className="text-sm">
                                        {team1Count} {team1Count === 1 ? 'player' : 'players'}
                                    </span>
                                </div>
                            </button>

                            <button
                                onClick={() => joinTeam('team2')}
                                disabled={isJoining || !playerName.trim()}
                                className="w-full bg-gradient-to-r from-pink-500 to-pink-700 text-white py-4 rounded-xl font-bold text-lg hover:shadow-lg transition disabled:opacity-50 disabled:cursor-not-allowed"
                            >
                                <div className="flex justify-between items-center px-4">
                                    <span>Join {gameState.teamNames.team2}</span>
                                    <span className="text-sm">
                                        {team2Count} {team2Count === 1 ? 'player' : 'players'}
                                    </span>
                                </div>
                            </button>

                            <button
                                onClick={() => joinTeam('team3')}
                                disabled={isJoining || !playerName.trim()}
                                className="w-full bg-gradient-to-r from-orange-500 to-orange-700 text-white py-4 rounded-xl font-bold text-lg hover:shadow-lg transition disabled:opacity-50 disabled:cursor-not-allowed"
                            >
                                <div className="flex justify-between items-center px-4">
                                    <span>Join {gameState.teamNames.team3}</span>
                                    <span className="text-sm">
                                        {team3Count} {team3Count === 1 ? 'player' : 'players'}
                                    </span>
                                </div>
                            </button>
                        </div>

                        {isJoining && (
                            <div className="mt-6 text-center">
                                <div className="animate-pulse text-gray-600">Joining quiz...</div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // HOST INTERFACE
        const HostInterface = ({ sessionId }) => {
            const [gameState, setGameState] = useState(null);
            const [isSetup, setIsSetup] = useState(true);
            const [teamNames, setTeamNames] = useState({ team1: '', team2: '', team3: '' });
            const [timer, setTimer] = useState(30);
            const [timerActive, setTimerActive] = useState(false);
            const [votes, setVotes] = useState({});
            const [showVotes, setShowVotes] = useState(false);
            const [showLinks, setShowLinks] = useState(false);
            const [showQR, setShowQR] = useState(false);
            const [copiedLink, setCopiedLink] = useState(null);
            const qrCanvasRef = useRef(null);

            useEffect(() => {
                const gameRef = database.ref(`sessions/${sessionId}/game`);
                gameRef.on('value', (snapshot) => {
                    const data = snapshot.val();
                    if (data) {
                        setGameState(data);
                        setIsSetup(false);
                    }
                });

                const votesRef = database.ref(`sessions/${sessionId}/votes`);
                votesRef.on('value', (snapshot) => {
                    setVotes(snapshot.val() || {});
                });

                return () => {
                    gameRef.off();
                    votesRef.off();
                };
            }, [sessionId]);

            useEffect(() => {
                let interval;
                if (timerActive && timer > 0) {
                    interval = setInterval(() => setTimer(t => t - 1), 1000);
                } else if (timer === 0) {
                    setTimerActive(false);
                    closeVoting();
                }
                return () => clearInterval(interval);
            }, [timerActive, timer]);

            useEffect(() => {
                if (showQR && qrCanvasRef.current) {
                    const joinUrl = `${window.location.origin}${window.location.pathname}?mode=join&session=${sessionId}`;
                    
                    // Check if QRCode library is loaded
                    if (typeof QRCode !== 'undefined') {
                        try {
                            QRCode.toCanvas(qrCanvasRef.current, joinUrl, {
                                width: 300,
                                margin: 2,
                                color: {
                                    dark: '#000000',
                                    light: '#ffffff'
                                }
                            }, (error) => {
                                if (error) {
                                    console.error('QR Code generation error:', error);
                                }
                            });
                        } catch (error) {
                            console.error('QR Code error:', error);
                        }
                    } else {
                        console.error('QRCode library not loaded');
                    }
                }
            }, [showQR, sessionId]);

            const initializeGame = async () => {
                if (!teamNames.team1 || !teamNames.team2 || !teamNames.team3) return;

                const initialState = {
                    teamNames,
                    scores: { team1: 0, team2: 0, team3: 0 },
                    currentRound: 0,
                    currentQuestion: 0,
                    showAnswer: false,
                    votingOpen: false
                };

                await database.ref(`sessions/${sessionId}/game`).set(initialState);
                await database.ref(`sessions/${sessionId}/playerAssignments`).set({});
            };

            const openVoting = async () => {
                setTimer(30);
                setTimerActive(true);
                await database.ref(`sessions/${sessionId}/game/votingOpen`).set(true);
                await database.ref(`sessions/${sessionId}/votes`).set(null);
            };

            const closeVoting = async () => {
                setTimerActive(false);
                await database.ref(`sessions/${sessionId}/game/votingOpen`).set(false);
                setShowVotes(true);
            };

            const calculateTeamAnswer = (teamId) => {
                const teamVotes = {};
                Object.entries(votes).forEach(([playerId, vote]) => {
                    if (playerId.startsWith(teamId) && vote.answer !== undefined) {
                        teamVotes[vote.answer] = (teamVotes[vote.answer] || 0) + 1;
                    }
                });

                if (Object.keys(teamVotes).length === 0) return null;

                const maxVotes = Math.max(...Object.values(teamVotes));
                const winners = Object.keys(teamVotes).filter(ans => teamVotes[ans] === maxVotes);
                
                return winners.length === 1 
                    ? parseInt(winners[0]) 
                    : parseInt(winners[Math.floor(Math.random() * winners.length)]);
            };

            const revealAnswer = async () => {
                await database.ref(`sessions/${sessionId}/game/showAnswer`).set(true);
                
                // Automatically award points to correct teams
                const team1Answer = calculateTeamAnswer('team1');
                const team2Answer = calculateTeamAnswer('team2');
                const team3Answer = calculateTeamAnswer('team3');
                
                const updates = {};
                
                if (team1Answer === currentQuestion.correct) {
                    const newScore = gameState.scores.team1 + currentQuestion.points;
                    updates[`scores/team1`] = newScore;
                }
                
                if (team2Answer === currentQuestion.correct) {
                    const newScore = gameState.scores.team2 + currentQuestion.points;
                    updates[`scores/team2`] = newScore;
                }
                
                if (team3Answer === currentQuestion.correct) {
                    const newScore = gameState.scores.team3 + currentQuestion.points;
                    updates[`scores/team3`] = newScore;
                }
                
                if (Object.keys(updates).length > 0) {
                    await database.ref(`sessions/${sessionId}/game`).update(updates);
                }
            };

            const nextQuestion = async () => {
                const nextQ = gameState.currentQuestion + 1;
                const nextR = gameState.currentRound;

                if (nextQ < QUIZ_DATA.rounds[nextR].questions.length) {
                    await database.ref(`sessions/${sessionId}/game`).update({
                        currentQuestion: nextQ,
                        showAnswer: false,
                        votingOpen: false
                    });
                } else if (nextR < QUIZ_DATA.rounds.length - 1) {
                    await database.ref(`sessions/${sessionId}/game`).update({
                        currentRound: nextR + 1,
                        currentQuestion: 0,
                        showAnswer: false,
                        votingOpen: false
                    });
                }
                setShowVotes(false);
                await database.ref(`sessions/${sessionId}/votes`).set(null);
            };

            const resetSession = async () => {
                if (confirm('This will clear all data and start fresh. Continue?')) {
                    await database.ref(`sessions/${sessionId}`).set(null);
                    setIsSetup(true);
                    setGameState(null);
                    setTeamNames({ team1: '', team2: '', team3: '' });
                }
            };

            const copyToClipboard = (text, id) => {
                navigator.clipboard.writeText(text);
                setCopiedLink(id);
                setTimeout(() => setCopiedLink(null), 2000);
            };

            if (isSetup) {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-purple-600 via-pink-500 to-orange-400 flex items-center justify-center p-4">
                        <div className="bg-white rounded-3xl shadow-2xl p-8 max-w-2xl w-full">
                            <h1 className="text-5xl font-bold text-center text-transparent bg-clip-text bg-gradient-to-r from-purple-600 to-pink-600 mb-8">
                                ðŸŽµ Spicks & Specks ðŸŽµ
                            </h1>
                            
                            <div className="space-y-6">
                                <div>
                                    <label className="block text-lg font-semibold mb-2">Team 1 Name</label>
                                    <input
                                        type="text"
                                        value={teamNames.team1}
                                        onChange={(e) => setTeamNames(prev => ({ ...prev, team1: e.target.value }))}
                                        className="w-full px-4 py-3 border-2 rounded-xl focus:outline-none"
                                    />
                                </div>
                                
                                <div>
                                    <label className="block text-lg font-semibold mb-2">Team 2 Name</label>
                                    <input
                                        type="text"
                                        value={teamNames.team2}
                                        onChange={(e) => setTeamNames(prev => ({ ...prev, team2: e.target.value }))}
                                        className="w-full px-4 py-3 border-2 rounded-xl focus:outline-none"
                                    />
                                </div>
                                
                                <div>
                                    <label className="block text-lg font-semibold mb-2">Team 3 Name</label>
                                    <input
                                        type="text"
                                        value={teamNames.team3}
                                        onChange={(e) => setTeamNames(prev => ({ ...prev, team3: e.target.value }))}
                                        className="w-full px-4 py-3 border-2 rounded-xl focus:outline-none"
                                    />
                                </div>
                                
                                <button
                                    onClick={initializeGame}
                                    disabled={!teamNames.team1 || !teamNames.team2 || !teamNames.team3}
                                    className="w-full bg-gradient-to-r from-purple-600 to-pink-600 text-white py-4 rounded-xl font-bold text-xl hover:shadow-lg transition disabled:opacity-50"
                                >
                                    Start Quiz Setup ðŸŽ¸
                                </button>
                            </div>
                        </div>
                    </div>
                );
            }

            if (!gameState) return <div className="p-8 text-center">Loading...</div>;

            const currentRound = QUIZ_DATA.rounds[gameState.currentRound];
            const currentQuestion = currentRound.questions[gameState.currentQuestion];
            const isMultipleChoice = currentQuestion.options !== undefined;

            const team1Answer = calculateTeamAnswer('team1');
            const team2Answer = calculateTeamAnswer('team2');
            const team3Answer = calculateTeamAnswer('team3');
            const team1Correct = team1Answer === currentQuestion.correct;
            const team2Correct = team2Answer === currentQuestion.correct;
            const team3Correct = team3Answer === currentQuestion.correct;

            const joinUrl = `${window.location.origin}${window.location.pathname}?mode=join&session=${sessionId}`;

            return (
                <div className="min-h-screen bg-gradient-to-br from-purple-600 via-pink-500 to-orange-400 p-4">
                    <div className="max-w-6xl mx-auto mb-6">
                        <div className="bg-white rounded-2xl shadow-lg p-4 flex justify-between items-center flex-wrap gap-4">
                            <div className="flex gap-8">
                                <div>
                                    <div className="text-sm text-gray-600">{gameState.teamNames.team1}</div>
                                    <div className="text-2xl font-bold text-purple-600">{gameState.scores.team1}</div>
                                </div>
                                <div>
                                    <div className="text-sm text-gray-600">{gameState.teamNames.team2}</div>
                                    <div className="text-2xl font-bold text-pink-600">{gameState.scores.team2}</div>
                                </div>
                                <div>
                                    <div className="text-sm text-gray-600">{gameState.teamNames.team3}</div>
                                    <div className="text-2xl font-bold text-orange-600">{gameState.scores.team3}</div>
                                </div>
                            </div>
                            
                            <div className="flex items-center gap-4">
                                <button
                                    onClick={() => setShowQR(!showQR)}
                                    className="px-3 py-2 bg-green-500 text-white text-sm rounded-lg hover:bg-green-600 transition flex items-center gap-2"
                                >
                                    <lucide-icon name="qr-code"></lucide-icon>
                                    {showQR ? 'Hide' : 'Show'} QR Code
                                </button>
                                
                                <button
                                    onClick={() => setShowLinks(!showLinks)}
                                    className="px-3 py-2 bg-blue-500 text-white text-sm rounded-lg hover:bg-blue-600 transition"
                                >
                                    {showLinks ? 'Hide' : 'Show'} Join Link
                                </button>
                                
                                <div className={`text-3xl font-bold ${timer <= 10 ? 'text-red-500' : 'text-gray-700'}`}>
                                    {timer}s
                                </div>
                                
                                <button
                                    onClick={resetSession}
                                    className="px-3 py-2 bg-red-500 text-white text-sm rounded-lg hover:bg-red-600 transition"
                                    title="Reset quiz and start over"
                                >
                                    Reset
                                </button>
                            </div>
                        </div>
                    </div>

                    {showQR && (
                        <div className="max-w-6xl mx-auto mb-6">
                            <div className="bg-white rounded-2xl shadow-lg p-8">
                                <h3 className="text-2xl font-bold mb-4 text-center">Scan to Join Quiz</h3>
                                <div className="flex flex-col items-center">
                                    <div className="mb-4 border-4 border-gray-200 rounded-xl overflow-hidden bg-white p-4">
                                        <canvas ref={qrCanvasRef} style={{ display: 'block' }}></canvas>
                                        <img 
                                            src={`https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=${encodeURIComponent(joinUrl)}`}
                                            alt="QR Code"
                                            className="w-[300px] h-[300px]"
                                            style={{ display: qrCanvasRef.current && qrCanvasRef.current.width > 0 ? 'none' : 'block' }}
                                        />
                                    </div>
                                    <p className="text-center text-gray-600 mb-2">
                                        Players scan this code to automatically join a team
                                    </p>
                                    <div className="bg-gray-100 px-4 py-2 rounded-lg text-sm text-gray-700 break-all max-w-lg text-center">
                                        {joinUrl}
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {showLinks && (
                        <div className="max-w-6xl mx-auto mb-6">
                            <div className="bg-white rounded-2xl shadow-lg p-6">
                                <h3 className="text-lg font-bold mb-4">Join Link (share this with players)</h3>
                                <div className="flex items-center gap-2">
                                    <input 
                                        type="text" 
                                        value={joinUrl} 
                                        readOnly 
                                        className="flex-1 px-4 py-2 border-2 rounded-lg bg-gray-50"
                                    />
                                    <button
                                        onClick={() => copyToClipboard(joinUrl, 'joinlink')}
                                        className={`px-4 py-2 rounded-lg ${
                                            copiedLink === 'joinlink' 
                                                ? 'bg-green-500 text-white' 
                                                : 'bg-gray-200 hover:bg-gray-300'
                                        }`}
                                    >
                                        {copiedLink === 'joinlink' ? 'âœ“ Copied!' : 'Copy'}
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    <div className="max-w-6xl mx-auto bg-white rounded-3xl shadow-2xl p-8">
                        <div className="text-center mb-8">
                            <div 
                                className="inline-block px-6 py-2 rounded-full text-white font-bold text-lg mb-4"
                                style={{ backgroundColor: currentRound.color }}
                            >
                                {currentRound.name}
                            </div>
                            <div className="text-gray-600">
                                Question {gameState.currentQuestion + 1} of {currentRound.questions.length}
                            </div>
                        </div>

                        <h2 className="text-3xl font-bold text-center mb-6">{currentQuestion.question}</h2>

                        {currentQuestion.spotifyEmbed && (
                            <div className="mb-6">
                                {currentQuestion.sampleInfo && (
                                    <div className="text-center text-gray-600 text-sm mb-2">{currentQuestion.sampleInfo}</div>
                                )}
                                <div className="flex justify-center">
                                    <iframe 
                                        src={currentQuestion.spotifyEmbed}
                                        width="100%" 
                                        height="152" 
                                        frameBorder="0" 
                                        allowtransparency="true" 
                                        allow="encrypted-media"
                                        className="rounded-xl max-w-2xl"
                                    ></iframe>
                                </div>
                            </div>
                        )}

                        {currentQuestion.lyrics && (
                            <div className="bg-gray-50 border-l-4 border-purple-500 p-6 rounded-r-lg mb-6">
                                <p className="italic whitespace-pre-line">{currentQuestion.lyrics}</p>
                            </div>
                        )}

                        {currentQuestion.imageUrl && (
                            <div className="mb-6 flex justify-center">
                                <img 
                                    src={currentQuestion.imageUrl} 
                                    alt="Quiz question"
                                    className={`max-w-full max-h-96 rounded-lg shadow-md ${currentQuestion.cropTop ? 'image-crop-top h-96 w-auto' : ''}`}
                                />
                            </div>
                        )}

                        {isMultipleChoice && (
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                                {currentQuestion.options.map((option, idx) => (
                                    <div
                                        key={idx}
                                        className={`p-4 border-2 rounded-xl ${
                                            gameState.showAnswer && idx === currentQuestion.correct
                                                ? 'bg-green-100 border-green-500'
                                                : 'border-gray-300'
                                        }`}
                                    >
                                        <span className="font-bold mr-2">{String.fromCharCode(65 + idx)}.</span>
                                        {option}
                                    </div>
                                ))}
                            </div>
                        )}

                        {showVotes && (
                            <div className="grid md:grid-cols-3 gap-4 mb-6">
                                <div className="border-2 border-purple-300 rounded-xl p-4">
                                    <h3 className="font-bold text-lg mb-2">{gameState.teamNames.team1} Votes</h3>
                                    <div className="space-y-1">
                                        {Object.entries(votes)
                                            .filter(([id]) => id.startsWith('team1'))
                                            .map(([id, vote]) => (
                                                <div key={id} className="text-sm">
                                                    {id}: {vote.answer !== undefined ? currentQuestion.options[vote.answer] : 'No vote'}
                                                </div>
                                            ))}
                                    </div>
                                    <div className="mt-3 pt-3 border-t-2">
                                        <span className="font-bold">Team Answer: </span>
                                        {team1Answer !== null ? (
                                            <span className={team1Correct ? 'text-green-600 font-bold' : 'text-red-600'}>
                                                {currentQuestion.options[team1Answer]} {team1Correct ? 'âœ“' : 'âœ—'}
                                            </span>
                                        ) : (
                                            <span className="text-gray-500">No votes</span>
                                        )}
                                    </div>
                                </div>

                                <div className="border-2 border-pink-300 rounded-xl p-4">
                                    <h3 className="font-bold text-lg mb-2">{gameState.teamNames.team2} Votes</h3>
                                    <div className="space-y-1">
                                        {Object.entries(votes)
                                            .filter(([id]) => id.startsWith('team2'))
                                            .map(([id, vote]) => (
                                                <div key={id} className="text-sm">
                                                    {id}: {vote.answer !== undefined ? currentQuestion.options[vote.answer] : 'No vote'}
                                                </div>
                                            ))}
                                    </div>
                                    <div className="mt-3 pt-3 border-t-2">
                                        <span className="font-bold">Team Answer: </span>
                                        {team2Answer !== null ? (
                                            <span className={team2Correct ? 'text-green-600 font-bold' : 'text-red-600'}>
                                                {currentQuestion.options[team2Answer]} {team2Correct ? 'âœ“' : 'âœ—'}
                                            </span>
                                        ) : (
                                            <span className="text-gray-500">No votes</span>
                                        )}
                                    </div>
                                </div>

                                <div className="border-2 border-orange-300 rounded-xl p-4">
                                    <h3 className="font-bold text-lg mb-2">{gameState.teamNames.team3} Votes</h3>
                                    <div className="space-y-1">
                                        {Object.entries(votes)
                                            .filter(([id]) => id.startsWith('team3'))
                                            .map(([id, vote]) => (
                                                <div key={id} className="text-sm">
                                                    {id}: {vote.answer !== undefined ? currentQuestion.options[vote.answer] : 'No vote'}
                                                </div>
                                            ))}
                                    </div>
                                    <div className="mt-3 pt-3 border-t-2">
                                        <span className="font-bold">Team Answer: </span>
                                        {team3Answer !== null ? (
                                            <span className={team3Correct ? 'text-green-600 font-bold' : 'text-red-600'}>
                                                {currentQuestion.options[team3Answer]} {team3Correct ? 'âœ“' : 'âœ—'}
                                            </span>
                                        ) : (
                                            <span className="text-gray-500">No votes</span>
                                        )}
                                    </div>
                                </div>
                            </div>
                        )}

                        {gameState.showAnswer && currentQuestion.trivia && (
                            <div className="bg-green-50 border-2 border-green-400 rounded-xl p-4 mb-6">
                                <p className="text-gray-700">ðŸ’¡ {currentQuestion.trivia}</p>
                            </div>
                        )}

                        <div className="flex gap-4 justify-center flex-wrap">
                            {!gameState.votingOpen && !showVotes && (
                                <button onClick={openVoting} className="px-6 py-3 bg-blue-500 text-white rounded-xl font-bold hover:bg-blue-600">
                                    Open Voting
                                </button>
                            )}
                            
                            {gameState.votingOpen && (
                                <button onClick={closeVoting} className="px-6 py-3 bg-orange-500 text-white rounded-xl font-bold hover:bg-orange-600">
                                    Close Voting
                                </button>
                            )}

                            {showVotes && !gameState.showAnswer && (
                                <button onClick={revealAnswer} className="px-6 py-3 bg-yellow-500 text-white rounded-xl font-bold hover:bg-yellow-600">
                                    Reveal Answer
                                </button>
                            )}

                            {gameState.showAnswer && (
                                <>
                                    <button onClick={nextQuestion} className="px-6 py-3 bg-gradient-to-r from-blue-500 to-cyan-500 text-white rounded-xl font-bold hover:shadow-lg flex items-center gap-2">
                                        Next Question
                                        <lucide-icon name="chevron-right"></lucide-icon>
                                    </button>
                                </>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        // PLAYER INTERFACE
        const PlayerInterface = ({ sessionId, playerId, teamId }) => {
            const [gameState, setGameState] = useState(null);
            const [selectedAnswer, setSelectedAnswer] = useState(null);
            const [hasVoted, setHasVoted] = useState(false);

            useEffect(() => {
                const gameRef = database.ref(`sessions/${sessionId}/game`);
                gameRef.on('value', (snapshot) => {
                    const data = snapshot.val();
                    setGameState(data);
                    if (data && !data.votingOpen) {
                        setSelectedAnswer(null);
                        setHasVoted(false);
                    }
                });

                return () => gameRef.off();
            }, [sessionId]);

            const submitVote = async () => {
                if (selectedAnswer === null) return;
                
                await database.ref(`sessions/${sessionId}/votes/${teamId}_${playerId}`).set({
                    answer: selectedAnswer,
                    timestamp: Date.now()
                });
                
                setHasVoted(true);
            };

            if (!gameState) {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-purple-600 to-pink-600 flex items-center justify-center p-4">
                        <div className="bg-white rounded-3xl shadow-2xl p-8 text-center">
                            <h2 className="text-2xl font-bold mb-4">Waiting for quiz to start...</h2>
                            <p className="text-gray-600">Your host will begin shortly!</p>
                        </div>
                    </div>
                );
            }

            const currentRound = QUIZ_DATA.rounds[gameState.currentRound];
            const currentQuestion = currentRound.questions[gameState.currentQuestion];
            const teamName = gameState.teamNames[teamId];

            return (
                <div className="min-h-screen bg-gradient-to-br from-purple-600 to-pink-600 flex items-center justify-center p-4">
                    <div className="bg-white rounded-3xl shadow-2xl p-8 max-w-2xl w-full">
                        <div className="text-center mb-6">
                            <div className={`text-2xl font-bold ${
                                teamId === 'team1' ? 'text-purple-600' : 
                                teamId === 'team2' ? 'text-pink-600' : 
                                'text-orange-600'
                            }`}>
                                {teamName}
                            </div>
                            <div className="text-gray-600">{playerId}</div>
                        </div>

                        <div className="mb-6">
                            <div className="bg-gray-100 rounded-xl p-4 mb-4">
                                <div className="font-bold mb-2">{currentRound.name}</div>
                                <div className="text-sm text-gray-600">
                                    Question {gameState.currentQuestion + 1} of {currentRound.questions.length}
                                </div>
                            </div>

                            <h2 className="text-xl font-bold mb-4">{currentQuestion.question}</h2>

                            {!gameState.votingOpen && !hasVoted && (
                                <div className="bg-yellow-50 border-2 border-yellow-400 rounded-xl p-4 text-center">
                                    <p className="font-semibold">Waiting for voting to open...</p>
                                </div>
                            )}

                            {gameState.votingOpen && !hasVoted && (
                                <>
                                    <div className="space-y-3 mb-6">
                                        {currentQuestion.options.map((option, idx) => (
                                            <button
                                                key={idx}
                                                onClick={() => setSelectedAnswer(idx)}
                                                className={`w-full p-4 border-2 rounded-xl text-left transition ${
                                                    selectedAnswer === idx
                                                        ? 'border-blue-500 bg-blue-50'
                                                        : 'border-gray-300 hover:border-blue-300'
                                                }`}
                                            >
                                                <span className="font-bold mr-2">{String.fromCharCode(65 + idx)}.</span>
                                                {option}
                                            </button>
                                        ))}
                                    </div>

                                    <button
                                        onClick={submitVote}
                                        disabled={selectedAnswer === null}
                                        className="w-full py-4 bg-gradient-to-r from-blue-500 to-cyan-500 text-white rounded-xl font-bold text-lg hover:shadow-lg transition disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2"
                                    >
                                        <lucide-icon name="send"></lucide-icon>
                                        Submit Vote
                                    </button>
                                </>
                            )}

                            {hasVoted && (
                                <div className="bg-green-50 border-2 border-green-400 rounded-xl p-6 text-center">
                                    <lucide-icon name="check-circle" className="mx-auto text-green-600 mb-2" size="48"></lucide-icon>
                                    <p className="font-bold text-lg text-green-800">Vote Submitted!</p>
                                    <p className="text-gray-600 mt-2">
                                        You selected: <span className="font-semibold">{currentQuestion.options[selectedAnswer]}</span>
                                    </p>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        lucide.createIcons();
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
